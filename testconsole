using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Net;
using System.Text;
using System.IO;
using System.Threading.Tasks;
using Titanium.Web.Proxy;
using Titanium.Web.Proxy.EventArguments;
using Titanium.Web.Proxy.Models;
using System.Collections;
using System.Net.Sockets;
using System.Net.NetworkInformation;
using System.Data.SqlClient;
using System.Web;
using Org.BouncyCastle.Asn1.Ocsp;
using System.Web.UI;

namespace ConsoleApplication1
{ 
    class Program
    {
        static void Main(string[] args)
        {
            var proxyServer = new ProxyServer();
            proxyServer.BeforeRequest += ProxyServer_BeforeRequestAsync;
            proxyServer.BeforeResponse += ProxyServer_BeforeResponse;
            proxyServer.AfterResponse += ProxyServer_AfterResponse;
            var explicitEndPoint = new ExplicitProxyEndPoint(IPAddress.Any, 8000, true);
            proxyServer.AddEndPoint(explicitEndPoint);
            proxyServer.Start();
            foreach (var endPoint in proxyServer.ProxyEndPoints)
                Console.WriteLine("Listening on '{0}' endpoint at Ip {1} and port: {2} ",
                    endPoint.GetType().Name, endPoint.IpAddress, endPoint.Port);

            proxyServer.SetAsSystemHttpProxy(explicitEndPoint);
            proxyServer.SetAsSystemHttpsProxy(explicitEndPoint);
            Console.ReadLine();
            proxyServer.BeforeRequest -= ProxyServer_BeforeRequestAsync;
            proxyServer.DisableSystemHttpProxy();
            proxyServer.DisableSystemHttpsProxy();
            proxyServer.Stop();            
        }

        private static async Task ProxyServer_BeforeRequestAsync(object sender, SessionEventArgs e)
        {
            Console.WriteLine(e.WebSession.Request.RequestUri.AbsoluteUri.ToString());  
            //If I go to https://www.google.com, I want to get only the answer of this address https://www.google.pl in the console - but I am currently getting something like this:
            //https://www.google.pl/
            //https://www.google.pl/gen_204?atyp=i&ei=r7gtXuH-MMrjkgW7tJ3gBw&ct=slh&v=2&s=2&pv=0.5647706042951375&me=46:1580054736951,V,0,0,0,0:68052,U,68052:3,V,0,0,1920,969:0,R,1,CAsQAA,166,172,600,607:0,R,1,CAsQAQ,166,172,600,607:0,R,1,CAIQAA,166,806,600,95:0,R,1,CAEQAA,166,928,600,95:0,R,1,CAQQAA,166,1050,600,95:274,h,1,CAEQAA,i:49,h,1,CAEQAA,o:1,h,1,CAIQAA,i:16,h,1,CAIQAA,o:18,h,1,CAsQAQ,i:0,h,1,CAsQAA,i:65,h,1,CAsQAQ,o:1,h,1,CAsQAA,o:1473,e,B&zx=1580054807070
            //https://www.google.pl/gen_204?atyp=i&ei=r7gtXuH-MMrjkgW7tJ3gBw&ct=slh&v=2&s=3&pv=0.5647706042951375&me=63:1580054807072,V,0,0,0,0:153,e,H&zx=1580054807689
            //https://dc.services.visualstudio.com/v2/track
            //https://www.google.pl/gen_204?s=webhp&t=aft&atyp=csi&ei=HLktXumBEIPRwAK086dA&rt=wsrt.4376,aft.381,prt.1003&bl=35MO&ima=1&imad=0&imn=3
            //https://www.google.pl/gen_204?atyp=csi&ei=HLktXumBEIPRwAK086dA&s=webhp&t=all&bl=35MO&imn=3&adh=&conn=onchange&ima=1&imad=0&ime=1&imex=1&imeh=1&imea=0&imeb=0&wh=969&scp=0&net=dl.6100,ect.4g,rtt.100&mem=ujhs.9,tjhs.13,jhsl.2198,dm.8&sto=&sys=hc.4&rt=xjsls.382,xjses.542,xjsee.660,xjs.661,iml.381,aft.381,prt.1003,dcl.1018,ol.1039,wsrt.4376,cst.2766,dnst.0,rqst.1516,rspt.980,sslt.2758,rqstt.3840,unt.18,cstt.1074,dit.5384&zx=1580054812346
            //https://adservice.google.pl/adsid/google/ui
            //https://adservice.google.com/adsid/google/ui?gadsid=AORoGNSrsidGq0daEw2HUvL5kbE8orr1aPMjNRKCsp3C88qTm37Ruk9apE9904bGL10OFkeOA9xo_qNMcTQ
            //https://vortex.data.microsoft.com/collect/v1
        }
    }
}
